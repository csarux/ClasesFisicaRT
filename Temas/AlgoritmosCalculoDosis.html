<!DOCTYPE html>
<html lang="en"><head>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-html/tabby.min.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/light-border.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.6.39">

  <meta name="author" content="César Rodríguez">
  <title>ClasesFisicaRT – Algoritmos para el cálculo de la dosis</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="../site_libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="../site_libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
  </style>
  <link rel="stylesheet" href="../site_libs/revealjs/dist/theme/quarto-e6ec3429f00f3dae4ab744fc8c423248.css">
  <link rel="stylesheet" href="styles.css">
  <link href="../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-chalkboard/font-awesome/css/all.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-chalkboard/style.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title">Algoritmos para el cálculo de la dosis</h1>
  <p class="subtitle">Haces de fotones, protones y electrones para radioterapia externa</p>

<div class="quarto-title-authors">
<div class="quarto-title-author">
<div class="quarto-title-author-name">
César Rodríguez 
</div>
<div class="quarto-title-author-email">
<a href="mailto:cesaro02@ucm.es">cesaro02@ucm.es</a>
</div>
        <p class="quarto-title-affiliation">
            Universidad Complutense de Madrid
          </p>
    </div>
</div>

</section>
<section id="section" class="slide level2 smaller">
<h2></h2>
<h3 id="funciones-del-sistema-de-planificación-de-radioterapia">Funciones del sistema de planificación de radioterapia</h3>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong><strong><em>RTPS</em></strong>: Sistema de planificación o <em>planificador</em></strong></p>
</div>
<div class="callout-content">
<p>Sistema informático en el que se implementan los algoritmos de cálculo, se configura para contener modelos matemáticos de las unidades de tratamiento y permite diseñar los tratamientos de radioterapia y transferirlos a las unidades de tratamiento.</p>
</div>
</div>
</div>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Diseño del tratamiento</strong></p>
</div>
<div class="callout-content">
<p>El diseño del tratamiento está formado por el conjunto de valores que fijan cada una de las variables disponibles para configurar los haces de tratamiento. Por cada haz: energía, tasa de dosis, unidades monitor, ángulo de gantry y colimador, posición de las mordazas, posición de cada una de las láminas en el MLC, coordenadas y ángulos para la posición de la mesa.</p>
</div>
</div>
</div>
<h4 id="funciones-operativas-del-planificador">Funciones operativas del <em>planificador</em></h4>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Calcular las unidades monitor UM</strong></p>
</div>
<div class="callout-content">
<p>Fijado un diseño de tratamiento, el planificador es capaz de calcular<sup>1</sup> cuántas UM son necesarias para dar la dosis de acuerdo a la prescripción del Oncólogo de Radioterapia.</p>
</div>
</div>
</div>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Calcular la distribución de dosis</strong></p>
</div>
<div class="callout-content">
<p>Fijado un diseño de tratamiento, el planificador es capaz de calcular la distribución espacial de la dosis en términos relativos a la dosis de prescripción.</p>
</div>
</div>
</div>
<aside><ol class="aside-footnotes"><li id="fn1"><p>La complejidad de los tratamientos actuales impide que los cálculos se realicen de forma manual, pero hasta relativamente poco tiempo, mientras se emplearon técnicas convencionales de tratamiento sin modulación de intensidad, se consideraba función específica de los Radiofísicos calcular manualmente las UM necesarias para llegar a la dosis de prescripción.</p></li></ol></aside></section>
<section id="haces-de-fotones" class="slide level2 smaller">
<h2>Haces de fotones</h2>
<div class="columns">
<div class="column" style="width:49%;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="images/CalculoSituacionEstandar.png" class="quarto-figure quarto-figure-center" height="200"></p>
</figure>
</div>
<p>En el <em>comisionado</em> hemos medido en esta situación y por interpolación podríamos calcular la dosis para otros diseños de tratamientos con disposiciones similares si se mantiene esta geometría estándar de irradiación.</p>
</div><div class="column" style="width:49%;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="images/CalculoSituacionReal.png" class="quarto-figure quarto-figure-center" height="200"></p>
</figure>
</div>
<p>Necesitamos calcular la dosis en condiciones geométricas alteradas respecto a la medida. Aparecen problemas de oblicuidad, inhomogeneidad e irregularidad.</p>
</div></div>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Perturbaciones respecto a la situación de referencia</strong></p>
</div>
<div class="callout-content">
<ul>
<li><strong>Incidencia oblicua</strong>: la tangente de la superficie no es perpendicular al eje del haz.</li>
<li><strong>Inhomogeneidad</strong>: el haz atraviesa medios de diferente densidad, o incluso parte del haz puede estar fuera del contorno del paciente.</li>
<li><strong>Asimetría</strong>: las mordazas se mueven de forma independiente y generan campos con dimensiones asimétricas respecto al eje del acelerador (recta que pasa por el foco y el eje de giro del colimador).</li>
<li><strong>Irregularidad del campo</strong>: el uso del MLC hace que la forma de los campos no sea paralelepípedos como los utilizados en el <em>comisionado</em>.</li>
</ul>
</div>
</div>
</div>
</section>
<section id="section-1" class="slide level2 smaller">
<h2></h2>
<h4 id="radioterapia-convencional-frente-a-intensidad-modulada">Radioterapia convencional frente a intensidad modulada</h4>

<img data-src="images/CovencionalIMRTCompleta.png" class="quarto-figure quarto-figure-center r-stretch"><div class="columns">
<div class="column" style="width:49%;">
<p>Se busca conseguir distribuciones uniformes de dosis con isodosis en forma de polígonos regulares. El diseño de tratamiento queda determinado por un espacio de fases reducido con algunas coordenadas prefijadas (por ejemplo, los ángulos de <em>gantry</em> y colimador). El cálculo puede ser realizado directamente por un humano.</p>
</div><div class="column" style="width:49%;">
<p>Se busca conseguir una máxima conformación de la dosis, isodosis curvas con incluso concavidades. El espacio de fases es enorme y <em>degenerado</em> (muchas soluciones alternativas posibles). La planificación es inversa, se optimiza la distribución de dosis iterando para acercarse a los objetivos fijados.</p>
</div></div>
</section>
<section id="section-2" class="slide level2 smaller">
<h2></h2>
<div class="columns">
<div class="column" style="width:30%;">
<p><strong>Componentes de la dosis consideradas en el cálculo</strong></p>
<ul>
<li>Primaria</li>
<li>Dispersión en el medio</li>
<li>Contaminación electrónica</li>
<li>Dispersión en el <em>gantry</em></li>
</ul>
</div><div class="column" style="width:70%;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="images/ContribucionesCalculoFotonesAhnesjo.png" class="quarto-figure quarto-figure-center" height="400"></p>
</figure>
</div>
</div></div>
<div class="columns">
<div class="column" style="width:49%;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="images/PortadaRevisionAhnesjo.png" class="quarto-figure quarto-figure-center" height="200"></p>
</figure>
</div>
</div><div class="column" style="width:49%;">
<p>La parte de esta clase que cubre los algoritmos de cálculo de tipo superposición convolución para haces de fotones está extraída del artículo de revisión de <a href="https://iopscience.iop.org/article/10.1088/0031-9155/44/11/201">Ahnesjö et al</a>.</p>
</div></div>
</section>
<section id="section-3" class="slide level2 smaller">
<h2></h2>
<h4 id="clasificación-de-los-algoritmos-de-cálculo">Clasificación de los algoritmos de cálculo</h4>
<p>Los algoritmos se clasifican por el modo en que contemplan el transporte de fotones y electrones</p>
<table class="caption-top">
<thead>
<tr class="header">
<th style="text-align: left;">Modo</th>
<th style="text-align: left;">Tipo</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Implícito</td>
<td style="text-align: left;">Convolución/superposición</td>
</tr>
<tr class="even">
<td style="text-align: left;">Explícito</td>
<td style="text-align: left;">Resolución eq. Boltzmann</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Explícito</td>
<td style="text-align: left;">Montecarlo</td>
</tr>
</tbody>
</table>
<ul>
<li>Los modelos implícitos tratan la dispersión de la radiación primaria mediante modelos precalculados de la dispersión que se denominan <em>kernels</em>.</li>
<li>El <em>kernel</em> se escala para incorporar el efecto de las inhomogeneidades.</li>
<li>Los modelos implícitos son menos exigentes computacionalmente que los modelos explícitos, en los que la dispersión se trata de forma más detallada.</li>
<li>Los modelos implícitos han sido los algoritmos de mayor implantación en los planificadores comerciales durante 25 años. Actualmente siguen siendo implementados en planificadores comerciales y en sistemas de cálculo paralelo<sup>1</sup></li>
</ul>
<aside><ol class="aside-footnotes"><li id="fn2"><p>Sistema en el que se reproduce el cálculo final de la dosis como método de control de calidad y comprobación de seguridad del planificador principal.</p></li></ol></aside></section>
<section id="section-4" class="slide level2 smaller">
<h2></h2>
<h3 id="cálculo-de-las-unidades-monitor-y-de-la-fluencia">Cálculo de las unidades monitor y de la fluencia</h3>
<h4 id="modelos-basados-en-la-relación-entre-la-dosis-y-la-fluencia-de-energía">Modelos basados en la relación entre la dosis y la fluencia de energía</h4>
<ul>
<li><p>La dosis es <span class="alert"><strong><em>lineal</em></strong></span> a la cantidad de radiación a la que el paciente está expuesto.</p></li>
<li><p>Esta linealidad permite expresar la dosis por unidad de fluencia <span class="math display">\[
d(x,y,z) = \frac{D(x,y,z|\Psi(A;x,y,z_0))}{\Psi_0}
\]</span> donde <span class="math inline">\(\Psi_0\)</span> es un nivel de fluencia de energía de referencia, <span class="math inline">\(A\)</span> es una variable de apertura general que representa todos los elementos de colimación y modulación del haz, y <span class="math inline">\(D(x,y,z|\Psi(A;x,y,z_0))\)</span> es la dosis absorbida en el punto <span class="math inline">\((x,y,z)\)</span> dada la fluencia <span class="math inline">\(\Psi(A;x,y,z_0)\)</span>.</p></li>
<li><p>La fluencia de energía de referencia <span class="math inline">\(\Psi_0\)</span> se define como la fluencia de energía primaria no dispersada en el aire en el punto de calibración, normalmente el isocentro.</p></li>
<li><p>Las variaciones laterales de la fluencia de energía primaria se introducen mediante una distribución relativa <span class="math inline">\(f(A;x,y,z_0)\)</span>: <span class="math display">\[
\Psi_{\text{prim}}(A;x,y,z_0) = \Psi_0 f(A;x,y,z_0)
\]</span></p></li>
</ul>
</section>
<section id="section-5" class="slide level2 smaller">
<h2></h2>
<ul>
<li>La fluencia total de fotones del haz se obtiene añadiendo los fotones dispersados desde las partes irradiadas del cabezal del tratamiento: <span class="math display">\[
\Psi(A;x,y,z_0) = \Psi_0 \left( f(A;x,y,z_0) + \frac{\Psi_{\text{hsc}}}{\Psi_0}(A;x,y,z_0) \right)
\]</span></li>
</ul>
<p><span class="alert"><strong>Unidades Monitor (UM)</strong></span></p>
<ul>
<li>Denotamos la UM como <span class="math inline">\(M\)</span>.</li>
<li>Las UM registradas para un haz dado se separan en dos partes, <span class="math inline">\(M_0\)</span> y <span class="math inline">\(M_b\)</span>.</li>
<li><span class="math inline">\(M_0\)</span> es la señal proporcional a la fluencia hacia adelante a través de la cámara de monitor.</li>
<li><span class="math inline">\(M_b = M_b(A) \approx M_0 \cdot b(A)\)</span> es proporcional a la fluencia de partículas retrodispersadas en el monitor desde la parte superior de los colimadores ajustables.</li>
<li>La fluencia total de energía entregada en el aire por unidad de monitor es: <span class="math display">\[
\frac{\Psi(A;x,y,z_0)}{M} = \frac{\Psi_0}{M_0 (1 + b(A))} \left( f(A;x,y,z_0) + \frac{\Psi_{\text{hsc}}}{\Psi_0}(A;x,y,z_0) \right)
\]</span></li>
</ul>
</section>
<section id="section-6" class="slide level2 smaller">
<h2></h2>
<p><span class="alert"><strong>Normalización de la Dosis</strong></span></p>
<ul>
<li>La relación entre las UM y la dosis para el campo <span class="math inline">\(A\)</span> será <span class="math display">\[
\frac{D(A;x,y,z)}{M} = \frac{\Psi_0}{M_0 (1 + b(A))} d(A;x,y,z)
\]</span></li>
</ul>
<p>donde el término <span class="math inline">\(\Psi/M_0\)</span> lo podemos obtener requiriendo que la dosis medida para un campo de calibración <span class="math inline">\(A_{\text{cal}}\)</span> y posición <span class="math inline">\((x_{\text{cal}}, y_{\text{cal}}, z_{\text{cal}})\)</span> sea igual a la dosis calculada para las mismas condiciones, obtenemos: <span class="math display">\[
  \frac{\Psi_0}{M_0} = \frac{[D(A_{\text{cal}}; x_{\text{cal}}, y_{\text{cal}}, z_{\text{cal}})/M]_{\text{Measured}}}{[D(A_{\text{cal}}; x_{\text{cal}}, y_{\text{cal}}, z_{\text{cal}})/\Psi_0]_{\text{Calculated}}} (1 + b(A_{\text{cal}}))
  \]</span></p>
<p><span class="alert"><strong>Modelos necesarios para implementar el formalismo</strong><sup>1</sup></span></p>
<ul>
<li>Modelo de la fluencia de energía primaria y la fluencia dispersada en el cabezal antes de ejecutar el motor de cálculo de dosis <span class="math inline">\(d(...)\)</span>.</li>
<li>Modelo de la retrodispersión del colimador hacia los monitores, indicada por <span class="math inline">\(b(A)\)</span>.</li>
</ul>
<aside><ol class="aside-footnotes"><li id="fn3"><p>Estos modelos se alimentan a partir de medidas realizadas en aire normalmente mediante perfiles diagonales para el mayor tamaño de campo disponible.</p></li></ol></aside></section>
<section id="cálculo-de-la-distribución-espacial-de-dosis-absorbida" class="slide level2 smaller">
<h2>Cálculo de la distribución espacial de dosis absorbida</h2>
<h3 id="métodos-implícitos-en-la-dosimetría">Métodos implícitos en la dosimetría</h3>
<h4 id="modelos-de-convoluciónsuperposición-basados-en-kernel">Modelos de convolución/superposición basados en <em>kernel</em></h4>
<ul>
<li>La deposición de dosis se ve como una superposición de respuestas (<em>kernels</em>) ponderadas apropiadamente a irradiaciones puntuales.</li>
<li>Bajo condiciones de invarianza, los kernels se superponen mediante convoluciones (altísima eficiencia computacional).</li>
<li>Los kernels no son medibles, pero son fáciles de calcular por Montecarlo.</li>
</ul>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Implementación clínica</strong></p>
</div>
<div class="callout-content">
<p>Su implementación en la clínica comenzó a partir de mediados de la década de los ochenta, pero no se generalizó en las implementaciones de los planificadores comerciales hasta comienzos de los años 2000.</p>
<p>Los modelos de kernel pueden manejar explícitamente el grado de libertad planteado por las máquinas de tratamiento modernas sin mayores aproximaciones, han sido en general la herramienta principal para aplicaciones de terapia conformacional.</p>
</div>
</div>
</div>
</section>
<section id="section-7" class="slide level2 smaller">
<h2></h2>
<h4 id="kernels-de-deposición-de-energía">Kernels de deposición de energía</h4>
<ul>
<li>Los fotones pueden viajar grandes distancias sin interaccionar. La energía y dirección de un fotón primario son independientes de dónde interactúa.</li>
<li>En medios homogéneos, la deposición de energía por partículas secundarias alrededor del sitio de interacción primaria es independiente de la ubicación del sitio y puede describirse mediante un kernel.</li>
<li>El kernel se define como la distribución de energía impartida por unidad de volumen en agua, por un haz de fotones elemental que incide en el origen de coordenadas del kernel.</li>
<li>Los kernels <span class="math inline">\(h(r)\)</span> se normalizan por la energía total que imparte el haz primario <span class="math display">\[
\int\int\int_{\infty} h(r)dV \equiv 1
\]</span></li>
<li>Separando un kernel puntual en uno para la dosis primaria (<span class="math inline">\(h_p\)</span>) y otro para la dosis dispersa en el maniquí (<span class="math inline">\(h_s\)</span>), la integral del kernel se relaciona con los coeficientes de absorción de energía</li>
</ul>
<p><span class="math display">\[
\int\int\int_{\infty} h_p(r)dV = \frac{\mu_{en}}{\mu} \quad \int\int\int_{\infty} h_s(r)dV = \frac{\mu - \mu_{en}}{\mu}
\]</span></p>
</section>
<section id="section-8" class="slide level2 smaller">
<h2></h2>
<h4 id="cálculo-de-kernels">Cálculo de Kernels</h4>
<div class="columns">
<div class="column" style="width:40%;">
<ul>
<li><p>Se calculan mediante métodos de Montecarlo<sup>1</sup></p></li>
<li><p>Se parametrizan<sup>2</sup> y tabulan: <span class="math display">\[
h(r) = \frac{A_{\theta}e^{-a_{\theta}r} + B_{\theta}e^{-b_{\theta}r}}{r^2}
\]</span></p></li>
<li><p><span class="math inline">\(A_{\theta}\)</span>, <span class="math inline">\(a_{\theta}\)</span>, <span class="math inline">\(B_{\theta}\)</span> y <span class="math inline">\(b_{\theta}\)</span> son parámetros de ajuste tabulados en función del ángulo de dispersión <span class="math inline">\(\theta\)</span>. El primer término describe principalmente la dosis primaria y el segundo término la fracción de dosis dispersa.</p></li>
</ul>
</div><div class="column" style="width:60%;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="images/AhnesjoPintKernesl.png" class="quarto-figure quarto-figure-center" height="500"></p>
</figure>
</div>
</div></div>
<aside><ol class="aside-footnotes"><li id="fn4"><p>Los kernels no se pueden medir directamente ni validar experimentalmente de forma directa porque no se puede forzar a un haz de fotones a interaccionar en un único punto.</p></li><li id="fn5"><p>Corregido respecto al original en el que no aparece la dependencia radial de las exponenciales.</p></li></ol></aside></section>
<section id="section-9" class="slide level2 smaller">
<h2></h2>
<h4 id="cálculo-de-la-dosis-a-partir-del-kernel-puntual">Cálculo de la dosis a partir del kernel puntual</h4>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="images/TermaDose.png" class="quarto-figure quarto-figure-center" height="240"></p>
</figure>
</div>
<ol type="1">
<li>Trazado de rayos de fotones primarios modulados por elementos del cabezal y del paciente. Se calcula la energía liberada en el paciente por las interacciones de estos fotones primarios (Terma).</li>
<li>Cálculo de la dosis mediante la superposición de kernels ponderados por el Terma:</li>
</ol>
<p><span class="math display">\[
D(r) = \int\int\int_V T(s)h(r - s)d^3s
\]</span></p>
<ul>
<li><span class="math inline">\(T(s)\)</span> es el Terma (energía total liberada por masa de la fluencia de energía de los fotones primarios <span class="math inline">\(\Psi(s)\)</span> en el elemento de volumen <span class="math inline">\(d^3s\)</span>.</li>
</ul>
</section>
<section id="section-10" class="slide level2 smaller">
<h2></h2>
<h4 id="aproximaciones-y-limitaciones-inherentes-a-los-modelos-de-superposición-de-kernel-puntual">Aproximaciones y limitaciones inherentes a los modelos de superposición de kernel puntual</h4>
<ul>
<li>Las propiedades espectrales y geométricas de las fuentes de rayos X clínicos.</li>
<li>El medio heterogéneo de extensión finita que es el paciente.</li>
<li>Las restricciones de tiempo impuestas por la planificación interactiva del tratamiento.</li>
</ul>
<h4 id="generalización-para-variaciones-espectrales-del-haz-primario">Generalización para variaciones espectrales del haz primario</h4>
<p>Los haces polienergéticos se tratan integrando también en energía:</p>
<p><span class="math display">\[
D(r) = \int_E \int\int\int_V T_E(s)h(E, r - s)d^3s dE
\]</span></p>
<p>donde la dependencia de la energía se incluye utilizando un kernel dependiente de la energía y un Terma diferencial en energía:</p>
<p><span class="math display">\[
T_E(r) = \frac{\mu}{\rho}(E, r)\Psi_E(r)
\]</span></p>
<p>El tiempo de cálculo se multiplica por el número de energías consideradas. En la práctica se consideran al menos cinco energías.</p>
</section>
<section id="section-11" class="slide level2 smaller">
<h2></h2>
<h4 id="dependencia-de-la-energía-con-la-posición">Dependencia de la energía con la posición</h4>
<ul>
<li><p>El haz primario se endurece con la profundidad y se ablanda a medida que nos alejamos del eje por el aumento relativo de radiación dispersa.</p></li>
<li><p>La variación de la calidad del haz afecta fundamentalmente al cálculo del Terma. <span class="math display">\[
D(r) = \int_E \int\int\int_V T_E(s)h(E, r - s)d^3s dE \approx \int\int\int_V P(s)\tilde{h}_p(r - s)d^3s + \int\int\int_V S(s)\tilde{h}_s(r - s)d^3s
\]</span></p></li>
</ul>
<p>donde las distribuciones de energía liberada para primaria, <span class="math inline">\(P\)</span> (es decir, el kerma de colisión), y dispersa, <span class="math inline">\(S\)</span>, se dan por:</p>
<p><span class="math display">\[
P(r) = \int T_E(r)\frac{\mu_{en}}{\mu}(E)dE \text{ ; }\quad S(r) = \int T_E(r)\left(1 - \frac{\mu_{en}}{\mu}(E)\right)dE
\]</span></p>
<p>con los kernels correspondientes ponderados por el Terma a una cierta profundidad <span class="math inline">\(z_0\)</span> y renormalizados para producir integrales unitarias sobre el espacio infinito</p>
<p><span class="math display">\[
\tilde{h}_p(r) = \frac{\int \Psi_E(z_0)\mu(E)h_p(E, r)dE}{\int \Psi_E(z_0)\mu_{en}(E)dE} \text{ ; }\quad
\tilde{h}_s(r) = \frac{\int \Psi_E(z_0)\mu(E)h_s(E, r)dE}{\int \Psi_E(z_0)(\mu(E) - \mu_{en}(E))dE}
\]</span></p>
</section>
<section id="section-12" class="slide level2 smaller">
<h2></h2>
<h4 id="divergencia-del-haz">Divergencia del haz</h4>
<div class="columns">
<div class="column" style="width:40%;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="images/KernelTilt.png" class="quarto-figure quarto-figure-center" height="500"></p>
</figure>
</div>
</div><div class="column" style="width:60%;">
<p>La divergencia del haz introduce:</p>
<ul>
<li>Un factor de reducción inverso al cuadrado de la distancia al foco,</li>
<li>Un aumento lineal de cada dimensión del campo con la profundidad</li>
<li>Una rotación, ‘inclinación’, de los kernels.</li>
</ul>
<p>Para acelerar el cálculo, la corrección por cuadrado de la distancia se introduce después de realizar la superposición en lugar de sobre la interacción primaria. Probablemente irrelevante en la actualidad con la potencia de cálculo disponible.</p>
<p>En la práctica, el uso de kernels paralelos es una aproximación aceptable para la mayoría de las situaciones clínicas y en general la inclinación de los kernels se ignora.</p>
</div></div>
</section>
<section id="section-13" class="slide level2 smaller">
<h2></h2>
<h4 id="escalado-de-densidad-con-la-heterogeneidad-del-tejido-y-extensión-finita-del-paciente">Escalado de densidad con la heterogeneidad del tejido y extensión finita del paciente</h4>
<p>Se escala el kernel puntual <span class="math inline">\(h_{\rho_0}\)</span> de un medio homogéneo de densidad másica <span class="math inline">\(\rho_0\)</span>, por la densidad electrónica media entre el punto <span class="math inline">\(s\)</span> de liberación de energía y el punto <span class="math inline">\(r\)</span> de deposición de energía</p>
<p><span class="math display">\[
h_{het}(s, r) = \frac{\rho(r)}{\rho_0} c^2 h_{\rho_0}[c\cdot (r - s)]
\]</span></p>
<p>donde</p>
<p><span class="math display">\[
c = c(s, r) = \int_0^1 \rho_{rel}[s - \lambda(s - r)] d\lambda
\]</span></p>
<p><span class="math inline">\(\rho_{rel}\)</span> es la densidad electrónica relativa al medio de referencia.</p>
<p>La integral de convolución para el cálculo de la dosis se reemplaza entonces por la integral de superposición:</p>
<p><span class="math display">\[
D(r) = \int\int\int_V T(s)\frac{\rho(s)}{\rho_0} c^2 h_{\rho_0}[c(r - s)] d^3s
\]</span></p>
</section>
<section id="section-14" class="slide level2 smaller">
<h2></h2>
<h3 id="métodos-explícitos.-solución-numérica-de-la-ecuación-de-transporte-de-boltzmann">Métodos explícitos. Solución numérica de la ecuación de transporte de Boltzmann</h3>
<div class="columns">
<div class="column" style="width:49%;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="images/IPEMBoltzmannRevision.png" class="quarto-figure quarto-figure-center" height="200"></p>
</figure>
</div>
</div><div class="column" style="width:49%;">
<p>La parte de esta clase que cubre los algoritmos de cálculo basados en la solución numérica de la ecuación de transporte de Boltzmann está extraída del artículo de revisión de <a href="https://iopscience.iop.org/article/10.1088/1361-6560/aaf0e2">James L. Bedford</a>.</p>
</div></div>
<ul>
<li>La <strong>ecuación de Boltzmann</strong> es la <em>relación integro-diferencial</em> que describe la <em>variación espacial de las fluencias</em> de fotones y electrones.</li>
<li>Toma en cuenta todas las interacciones que se producen en el paciente, y cómo modifican la fluencia.</li>
<li>Puesto que en las interacciones de fotones se producen electrones, y al contrario, la fluencia de fotones aparece también en la ecuación de la fluencia de electrones, y viceversa.</li>
</ul>
</section>
<section id="section-15" class="slide level2 smaller">
<h2></h2>
<div class="columns">
<div class="column" style="width:49%;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="images/IntercambiosFluenciaBoltzmann.png" class="quarto-figure quarto-figure-center"></p>
</figure>
</div>
</div><div class="column" style="width:49%;">
<h4 id="balance-de-fluencias">Balance de fluencias</h4>
<ul>
<li>El gradiente de la fluencia en una dirección y un punto determinados depende del balance de partículas que se añaden o sustraen por fenómenos de dispersión y absorción.</li>
<li>Las pérdidas en una dirección se convierten en contribuciones en otra.</li>
<li>Su solución proporciona la distribución espacial de la fluencia y con ella la dosis absorbida.</li>
</ul>
</div></div>
</section>
<section id="section-16" class="slide level2 smaller">
<h2></h2>
<div class="columns">
<div class="column" style="width:49%;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="images/BoltzmannEqComptonScheme.png"></p>
<figcaption>Interacción Compton fotón electrón</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="images/BoltzmannEqMollerScheme.PNG"></p>
<figcaption>Interacción electrón electrón inelástica</figcaption>
</figure>
</div>
</div><div class="column" style="width:49%;">
<h4 id="interacciones-consideradas-en-el-cálculo">Interacciones consideradas en el cálculo</h4>
<p>En haces de radioterapia externa, para no complicar la ecuación en exceso, se suelen considerar solo las interacciones más relevantes de modo simplificado.</p>
<ul>
<li>Dispersión fotón e- (Compton)</li>
<li>Dispersiones inelásticas e- e- (Møller)</li>
<li>Dispersiones elásticas núcleo e- (Mott)</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="images/BoltzmannEqMottScheme.PNG"></p>
<figcaption>Interacción electrón núcleo elástica</figcaption>
</figure>
</div>
</div></div>
</section>
<section id="section-17" class="slide level2 smaller">
<h2></h2>
<h4 id="lista-de-símbolos">Lista de símbolos</h4>
<ul>
<li><span class="math inline">\(\Omega_\gamma\)</span>: una normal unitaria en la dirección de interés, subíndice según el tipo de radiación.</li>
<li><span class="math inline">\(r\)</span>: la posición de interés.</li>
<li><span class="math inline">\(E_\gamma\)</span>: la energía de interés del fotón.</li>
<li><span class="math inline">\(E_e\)</span>: la energía de interés del electrón.</li>
<li><span class="math inline">\(\rho_c(r)\)</span>: la densidad de núcleos atómicos en la posición <span class="math inline">\(r\)</span>.</li>
<li><span class="math inline">\(\rho_e(r)\)</span>: la densidad de electrones en la posición <span class="math inline">\(r\)</span>.</li>
<li><span class="math inline">\(\Phi_\gamma(r, \Omega_\gamma, E_\gamma)\)</span>: la fluencia de fotones en la posición <span class="math inline">\(r\)</span>, con dirección <span class="math inline">\(\Omega_\gamma\)</span> y energía <span class="math inline">\(E_\gamma\)</span>.</li>
<li><span class="math inline">\(\Phi_e(r, \Omega_e, E_e)\)</span>: la fluencia de electrones en la posición <span class="math inline">\(r\)</span>, con dirección <span class="math inline">\(\Omega_e\)</span> y energía <span class="math inline">\(E_e\)</span>.</li>
<li><span class="math inline">\(\tilde{\sigma}_{C,\gamma}(E'_\gamma, E_\gamma, \Omega'_\gamma \cdot \Omega_\gamma)\)</span>: la sección transversal diferencial de dispersión Compton de un fotón que viaja inicialmente con energía <span class="math inline">\(E'_\gamma\)</span> en la dirección <span class="math inline">\(\Omega'_\gamma\)</span> y finalmente con energía <span class="math inline">\(E_\gamma\)</span> y dirección <span class="math inline">\(\Omega_\gamma\)</span>.</li>
<li><span class="math inline">\(\tilde{\sigma}_{C,e}(E'_\gamma, E_e, \Omega'_\gamma \cdot \Omega_e)\)</span>: la sección transversal diferencial de dispersión Compton de un fotón que viaja inicialmente con energía <span class="math inline">\(E'_\gamma\)</span> en la dirección <span class="math inline">\(\Omega'_\gamma\)</span> y que da lugar a un electrón que viaja con energía <span class="math inline">\(E_e\)</span> y dirección <span class="math inline">\(\Omega_e\)</span>.</li>
</ul>
</section>
<section id="section-18" class="slide level2 smaller">
<h2></h2>
<ul>
<li><span class="math inline">\(\tilde{\sigma}_M(E'_e, E_e, \Omega'_e \cdot \Omega_e)\)</span>: la sección transversal diferencial de dispersión Møller de un electrón que viaja inicialmente con energía <span class="math inline">\(E'_e\)</span> en la dirección <span class="math inline">\(\Omega'_e\)</span> y finalmente con energía <span class="math inline">\(E_e\)</span> y dirección <span class="math inline">\(\Omega_e\)</span>.</li>
<li><span class="math inline">\(\sigma_{\text{Mott}}(E_e, \Omega'_e \cdot \Omega_e)\)</span>: la sección transversal diferencial de dispersión Mott de un electrón que viaja con energía <span class="math inline">\(E_e\)</span>, inicialmente en la dirección <span class="math inline">\(\Omega'_e\)</span> y finalmente en la dirección <span class="math inline">\(\Omega_e\)</span>.</li>
<li><span class="math inline">\(\sigma_{\text{totM}}(E_e)\)</span>: la sección transversal total de dispersión Møller para un electrón que viaja inicialmente con energía <span class="math inline">\(E_e\)</span>.</li>
<li><span class="math inline">\(\sigma_{\text{totMott}}(E_e)\)</span>: la sección transversal total de dispersión Mott para un electrón que viaja inicialmente con energía <span class="math inline">\(E_e\)</span>.</li>
</ul>
<p><strong>Nota</strong>: El apóstrofo se usa para denotar la energía y dirección iniciales.</p>
</section>
<section id="section-19" class="slide level2 smaller">
<h2></h2>
<h4 id="transporte-de-fotones">Transporte de fotones</h4>
<p><span class="math display">\[
\begin{aligned}
\colorbox{AquaMarine}{$\displaystyle\Omega_\gamma \cdot \nabla \Phi_\gamma(r, \Omega_\gamma, E_\gamma)$} =
\colorbox{Apricot}{$\displaystyle\rho_e(r) \int_0^\infty \int_{4\pi} \tilde{\sigma}_{C,\gamma}(E'_\gamma, E_\gamma, \Omega'_\gamma \cdot \Omega_\gamma)
\Phi_\gamma(r, \Omega'_\gamma, E'_\gamma) d\Omega'_\gamma dE'_\gamma $}
\\
- \colorbox{SkyBlue}{$\displaystyle\rho_e(r) \sigma_{\text{totC},\gamma}(E_\gamma) \Phi_\gamma(r, \Omega_\gamma, E_\gamma)$}
\end{aligned}
\]</span></p>
<ul>
<li><span style="background-color: #7FFFD0"><strong>Variación del flujo de fotones</strong></span>: Proyección en la dirección <span class="math inline">\(\Omega_\gamma\)</span> de la variación local en <span class="math inline">\(r\)</span> de la fluencia de fotones con dirección <span class="math inline">\(\Omega_\gamma\)</span> y energía <span class="math inline">\(E_\gamma\)</span>.
<ul>
<li><span style="background-color: #FBCEB1"><strong>Entrantes (partículas que se añaden)</strong></span>: Fotones con energía inicial <span class="math inline">\(E'_\gamma\)</span> que provienen de la dirección <span class="math inline">\(\Omega'_\gamma\)</span> que tras interaccionar en el punto <span class="math inline">\(r\)</span> entran en la dirección <span class="math inline">\(\Omega_\gamma\)</span> con energía <span class="math inline">\(E_\gamma\)</span>.</li>
<li><span style="background-color: #87CEEB"><strong>Salientes (partículas que se restan)</strong></span>: Número total de fotones en la dirección <span class="math inline">\(\Omega_\gamma\)</span> con energía <span class="math inline">\(E_\gamma\)</span> que al interaccionar en la posición <span class="math inline">\(r\)</span> cambian a cualquier otra dirección llevándose la energía correspondiente.</li>
</ul></li>
</ul>
</section>
<section id="section-20" class="slide level2 smaller">
<h2></h2>
<h4 id="dispersiones-múltiples-de-fotones">Dispersiones múltiples de fotones</h4>
<p>La solución a la ecuación anterior se simplifica considerando explícitamente los eventos de dispersión múltiple, estratificando por el número de dispersiones sufridas.</p>
<p>La fluencia de fotones <span class="math inline">\((M-1)\)</span> veces dispersados son fuente de los fotones dispersados <span class="math inline">\(M\)</span> veces:</p>
<p><span class="math display">\[
\Omega_\gamma \cdot \nabla \Phi^{(M)}_\gamma = \rho_e \int_0^\infty \int_{4\pi} \tilde{\sigma}_{C,\gamma} \Phi^{(M-1)}_\gamma d\Omega'_\gamma dE'_\gamma - \rho_e \sigma_{\text{totC},\gamma} \Phi^{(M)}_\gamma
\]</span></p>
<p>Los fotones tienen camino libre medio en el tejido grande. El número de eventos de dispersión en el paciente es bajo, 2 o 3 (por ejemplo, <span class="math inline">\(M = 0...2\)</span>).</p>
<p>Es frecuente incluso considerar una única dispersión, los fotones se dividen en fluencias no dispersadas <span class="math inline">\(\Phi^{(\text{unc})}_\gamma\)</span> y dispersadas <span class="math inline">\(\Phi^{(\text{coll})}_\gamma\)</span>.</p>
<ul>
<li><span class="math inline">\(\Phi^{(\text{unc})}_\gamma\)</span> se calcula analíticamente utilizando trazado de rayos.</li>
<li><span class="math inline">\(\Phi^{(\text{coll})}_\gamma\)</span> se calcula utilizando la ecuación anterior, con la fluencia de fotones no colisionados, <span class="math inline">\(\Phi^{(\text{unc})}_\gamma\)</span>, como fuente fija.</li>
</ul>
</section>
<section id="section-21" class="slide level2 smaller">
<h2></h2>
<h4 id="transporte-de-electrones">Transporte de electrones</h4>
<p><span class="math display">\[
\begin{aligned}
\colorbox{AquaMarine}{$\displaystyle\Omega_e \cdot \nabla \Phi_e(r, \Omega_e, E_e) $} =
\colorbox{Apricot}{$\displaystyle\rho_e(r) \int_0^\infty \int_{4\pi} \tilde{\sigma}_{C,e}(E'_\gamma, E_e, \Omega'_\gamma \cdot \Omega_e) \Phi_\gamma(r, \Omega'_\gamma, E'_\gamma) d\Omega'_\gamma dE'_\gamma$} \\
+ \colorbox{Bisque}{$\displaystyle\rho_e(r) \int_0^\infty \int_{4\pi} \tilde{\sigma}_M(E'_e, E_e, \Omega'_e \cdot \Omega_e) \Phi_e(r, \Omega'_e, E'_e) d\Omega'_e dE'_e$} \\
+ \colorbox{Beige}{$\displaystyle\rho_c(r) \int_{4\pi} \sigma_{Mott}(r, E_e, \Omega'_e \cdot \Omega_e) \Phi_e(r, \Omega'_e, E_e) d\Omega'_e $}\\
- \colorbox{SkyBlue}{$\displaystyle\rho_e(r) \sigma^{\text{tot}}_M(E_e) \Phi_e(r, \Omega_e, E_e)$} \\
- \colorbox{lightcyan}{$\displaystyle\rho_c(r) \sigma^{\text{tot}}_{\text{Mott}}(r, E_e) \Phi_e(r, \Omega_e, E_e)$}.
\end{aligned}
\]</span></p>
<ul>
<li><span style="background-color: #7FFFD0"><strong>Variación del flujo de electrones</strong></span>: Proyección en la dirección <span class="math inline">\(\Omega_e\)</span> de la variación local en <span class="math inline">\(r\)</span> de la fluencia de electrones con dirección <span class="math inline">\(\Omega_e\)</span> y energía <span class="math inline">\(E_e\)</span>.
<ul>
<li><span style="background-color: #FBCEB1"><strong>Electrones añadidos Compton</strong></span>: Electrones con energía <span class="math inline">\(E_e\)</span> lanzados en la dirección <span class="math inline">\(\Omega_e\)</span> al dispersarse en el punto <span class="math inline">\(r\)</span> un fotón de energía <span class="math inline">\(E'_\gamma\)</span> que proviene de la dirección <span class="math inline">\(\Omega'_\gamma\)</span>.</li>
</ul></li>
</ul>
</section>
<section id="section-22" class="slide level2 smaller">
<h2></h2>
<ul>
<li><p><span style="background-color: #FFE4C4"><strong>Electrones añadidos por dispersiones inelásticas</strong></span>: Electrones con energía <span class="math inline">\(E_e\)</span> que entran en la dirección <span class="math inline">\(\Omega_e\)</span> al interaccionar inelásticamente con otro electrón en el punto <span class="math inline">\(r\)</span> y perder parte de su energía <span class="math inline">\(E'_e\)</span> y cambiar su dirección inicial <span class="math inline">\(\Omega'_e\)</span>.</p></li>
<li><p><span style="background-color: #F5F5DC"><strong>Electrones añadidos por dispersiones elásticas</strong></span>: Electrones con energía <span class="math inline">\(E_e\)</span> que entran en la dirección <span class="math inline">\(\Omega_e\)</span> al interaccionar elásticamente con un átomo y cambiar su dirección inicial <span class="math inline">\(\Omega'_e\)</span>.</p></li>
<li><p><span style="background-color: #87CEEB"><strong>Electrones restados por dispersiones inelásticas</strong></span>: Electrones que están en la dirección <span class="math inline">\(\Omega_e\)</span> y tienen energía <span class="math inline">\(E_e\)</span> que al interaccionar inelásticamente con otro electrón en la posición <span class="math inline">\(r\)</span> cambian a cualquier otra dirección llevándose la energía correspondiente.</p></li>
<li><p><span style="background-color: #E0FFFF"><strong>Electrones restados por dispersiones elásticas</strong></span>: Electrones que están en la dirección <span class="math inline">\(\Omega_e\)</span> y tienen energía <span class="math inline">\(E_e\)</span> que al interaccionar elásticamente con un átomo en la posición <span class="math inline">\(r\)</span> cambian a cualquier otra dirección llevándose la energía correspondiente.</p></li>
</ul>
</section>
<section id="section-23" class="slide level2 smaller">
<h2></h2>
<h4 id="cálculo-de-la-dosis">Cálculo de la dosis</h4>
<ul>
<li><p>La energía se deposita en el medio por los electrones.</p></li>
<li><p>Se resuelven las ecuaciones para obtener <span class="math inline">\(\Phi_e\)</span> y <span class="math inline">\(\Phi_\gamma\)</span>. No es posible obtener únicamente <span class="math inline">\(\Phi_e\)</span> porque el efecto Compton acopla las dos fluencias <span class="math inline">\(\Phi_e\)</span> y <span class="math inline">\(\Phi_\gamma\)</span>.</p></li>
<li><p>La dosis se calcula a partir del poder de frenado (pérdida de energía por unidad de distancia recorrida):</p></li>
</ul>
<p><span class="math display">\[
S(r, E_e) = \rho_e(r) \int_0^{E_e} (E_e - E'_e) \tilde{\sigma}_M(E_e, E'_e) dE'_e
\]</span></p>
<p>integrando sobre todas las direcciones de fluencia (Larsen et al 1997):</p>
<p><span class="math display">\[
D(r) = \frac{1}{\rho(r)} \int_0^\infty \int_{4\pi} S(r, E'_e) \Phi_e(r, \Omega'_e, E'_e) d\Omega' dE'_e,
\]</span></p>
<ul>
<li>El único proceso de deposición de energía es la dispersión de Møller:</li>
</ul>
<p><span class="math display">\[
D(r) = \rho_e(r) \int_{4\pi} \int_{4\pi} \int_0^\infty \int_0^\infty \tilde{\sigma}_M(E'_e, E_e, \Omega'_e \cdot \Omega_e) \Phi_e(r, \Omega'_e, E'_e) \cdot (E'_e - E_e) dE_e dE'_e d\Omega_e d\Omega'_e.
\]</span></p>
</section>
<section id="section-24" class="slide level2 smaller">
<h2></h2>
<h4 id="aproximaciones-estándar">Aproximaciones estándar</h4>
<ul>
<li><p>Algunas integrales son reducibles a sumas de unos pocos términos expandiendo la dependencia angular de las secciones eficaces en polinomios de Legendre y las fluencias en armónicos esféricos.</p></li>
<li><p>La dispersión elástica de los electrones se trata a través de la aproximación de Focker-Planck que básicamente asume que los electrones pierden energía de forma continua con pequeños cambios de dirección.</p></li>
<li><p>La dispersión inelástica se trata mediante la aproximación de frenado continuo que también asume pequeñas pérdidas de energía pero permite cambios grandes de dirección.</p></li>
</ul>
<h4 id="espacio-de-fases-y-discretización">Espacio de fases y discretización</h4>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Espacio de fases</strong></p>
</div>
<div class="callout-content">
<p>Es el conjunto de variables que caracterizan completamente el problema. Para describir la fluencia necesitamos el tipo de partícula (fotones o electrones), las coordenadas espaciales, la energía y la dirección.</p>
</div>
</div>
</div>
<ul>
<li>Resolver la ecuación de transporte por métodos numéricos implica que cada una de las variables del espacio de fases se tiene que discretizar.</li>
<li>El modo de discretización no es único y es relevante para los algoritmos numéricos que se empleen. Por ejemplo, en lugar de nodos en ejes cartesianos se suele emplear un mallado triangular que es más natural para computar las dispersiones que se dan en la práctica.</li>
</ul>
</section>
<section id="section-25" class="slide level2 smaller">
<h2></h2>
<h4 id="soluciones-matriciales">Soluciones matriciales</h4>
<p>La fluencia en un voxel depende de la fluencia en otros vóxeles. Expresado en forma matricial:</p>
<p><span class="math display">\[
A\Phi = b,
\]</span></p>
<ul>
<li>El sistema lineal se vuelve gigante con el número de variables a resolver.</li>
<li>Para <span class="math inline">\(N \times N \times N\)</span> vóxeles en tres dimensiones, con fotones y electrones, <span class="math inline">\(D\)</span> direcciones y <span class="math inline">\(E\)</span> energías a considerar, <span class="math inline">\(\Phi\)</span> tiene <span class="math inline">\(2DEN^3\)</span> componentes y la matriz <span class="math inline">\(A\)</span> tiene <span class="math inline">\(2DEN^3 \times 2DEN^3\)</span> elementos.</li>
<li>La matriz <span class="math inline">\(A\)</span> es dispersa porque un voxel solo contribuye a vóxeles adyacentes.</li>
<li>Se pueden usar métodos de solución de matrices dispersas (Gauss-Seidel) para hacer la solución manejable.</li>
<li>La matriz <span class="math inline">\(A\)</span> se descompone en la suma de una matriz triangular inferior, una matriz diagonal y una matriz triangular superior, se invierte y se itera partiendo de una solución aproximada (fluencia primaria):</li>
</ul>
<p><span class="math display">\[
A = L + D + U.
\]</span></p>
<p><span class="math display">\[
(L + D)\Phi = b - U\Phi,
\]</span> <span class="math display">\[
\Phi_{i+1} = (L + D)^{-1} (b - U\Phi_i),
\]</span></p>
</section>
<section id="section-26" class="slide level2 smaller">
<h2></h2>
<h4 id="ejemplo-1d">Ejemplo 1D</h4>
<div class="columns">
<div class="column" style="width:30%;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="images/Ejemplo1D.png" class="quarto-figure quarto-figure-center" height="400"></p>
</figure>
</div>
</div><div class="column" style="width:70%;">
<p>Volumen semi-infinito, borde superior irradiado uniformemente con una fluencia unitaria de fotones monoenergéticos, <span class="math inline">\(\Phi_{1/2} = 1\)</span>. El transporte de electrones se desprecia. Los fotones solo viajan en la dirección descendente. Consideramos vóxeles de tamaño unitario a lo largo del centro del volumen. La ecuación de transporte para cada voxel <span class="math inline">\(i\)</span> resulta</p>
<p><span class="math display">\[
\colorbox{AquaMarine}{$\Phi_{i+1/2} - \Phi_{i-1/2}$}
+ \colorbox{SkyBlue}{$\rho_e (x) \sigma_{\text{totC},\gamma} \Phi_i (x)$}
= \colorbox{Apricot}{$Q_i (x)$}.
\]</span></p>
<p>Definimos <span class="math inline">\(a\)</span> la integral de fotones dispersados que se unen a la dirección positiva <span class="math inline">\(x\)</span>:</p>
<p><span class="math display">\[
a = \frac{Q_i (x)}{\Phi(x)}
\]</span></p>
</div></div>
<p>o simplemente la fracción de fotones que al dispersarse entran en la dirección <span class="math inline">\(x\)</span> y</p>
<p><span class="math display">\[
b = \rho_e(x,y,z) \sigma_{\text{totC},\gamma},
\]</span></p>
<p>fracción de fotones que dejan la dirección <span class="math inline">\(x\)</span>.</p>
</section>
<section id="section-27" class="slide level2 smaller">
<h2></h2>
<p>Considerando que la fluencia en el centro del voxel es el promedio de los valores sobre las superficies de separación:</p>
<p><span class="math display">\[
\Phi_{i+1/2} - \Phi_{i-1/2} + \frac{b}{2} (\Phi_{i+1/2} + \Phi_{i-1/2}) - \frac{a}{2} (\Phi_{i+1/2} + \Phi_{i-1/2}) = 0,
\]</span></p>
<p>si consideramos cinco vóxeles, nos da el sistema lineal de la forma:</p>
<p><span class="math display">\[
\begin{bmatrix}
1 &amp; 0 &amp; 0 &amp; 0 &amp; 0  \\
\frac{b-a}{2} -1 &amp; \frac{b-a}{2} + 1 &amp; 0 &amp; 0 &amp; 0 \\
0 &amp; \frac{b-a}{2} -1 &amp; \frac{b-a}{2} + 1 &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; \frac{b-a}{2} -1 &amp; \frac{b-a}{2} + 1  &amp; 0 \\
0 &amp; 0 &amp; 0 &amp; \frac{b-a}{2} -1 &amp; \frac{b-a}{2} + 1 \\
\end{bmatrix}
\begin{bmatrix}
\Phi_{1/2} \\
\Phi_{3/2} \\
\Phi_{5/2} \\
\Phi_{7/2} \\
\Phi_{9/2} \\
\end{bmatrix}
=
\begin{bmatrix}
1 \\
0 \\
0 \\
0 \\
0 \\
\end{bmatrix}
\]</span></p>
<p>La forma de la matriz es casi diagonal. Se puede resolver mediante una inversión estándar:</p>
<p><span class="math display">\[
\Phi = A^{-1}b.
\]</span></p>
</section>
<section id="section-28" class="slide level2 smaller">
<h2></h2>
<p>Resulta una solución cerrada:</p>
<p><span class="math display">\[
\Phi_{i+1/2} = \left( \frac{a - b + 2}{b - a + 2} \right)^i \Phi_{1/2}, \quad (i = 0, 1, 2, \ldots),
\]</span></p>
<p>en la cual <span class="math inline">\(\Phi_{1/2}\)</span> es unidad. La fluencia en el centro de los vóxeles:</p>
<p><span class="math display">\[
\Phi_{i+1} = \left( \frac{a - b + 2}{b - a + 2} \right)^i \left( \frac{2}{b - a + 2} \right) \Phi_{1/2}.
\]</span></p>
<div class="columns">
<div class="column" style="width:50%;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="images/SolucionEjemplo1D.png" class="quarto-figure quarto-figure-center" height="300"></p>
</figure>
</div>
</div><div class="column" style="width:50%;">
<ul>
<li>Bajo estas condiciones simplificadas, la solución es la esperable atenuación exponencial de la fluencia.</li>
<li>La dosis bajo condiciones de deposición local la podemos calcular como la reducción de la fluencia de energía.</li>
<li>Como la diferencial de una exponencial sigue siendo exponencial, la dosis se atenúa exponencialmente.</li>
</ul>
</div></div>
</section>
<section id="section-29" class="slide level2 smaller">
<h2></h2>
<h4 id="solución-por-métodos-numéricos">Solución por métodos numéricos</h4>
<ul>
<li>La solución por métodos numéricos se obtendría mediante el enfoque de iteración de fuente.</li>
<li>Partimos de una estimación inicial de la distribución de fluencia, con todos sus elementos iguales a cero salvo el término <span class="math inline">\(\Phi_{1/2}\)</span> que lo igualamos al valor de contorno.</li>
<li>Para valores de <span class="math inline">\(a = 0.1\)</span> y <span class="math inline">\(b = 0.5\)</span>, podemos ver cómo solucionar el problema por inversión directa:</li>
</ul>
<p><span class="math display">\[
A =
\begin{bmatrix}
1 &amp; 0 &amp; 0 &amp; 0 &amp; 0  \\
\frac{b-a}{2} -1 &amp; \frac{b-a}{2} + 1 &amp; 0 &amp; 0 &amp; 0 \\
0 &amp; \frac{b-a}{2} -1 &amp; \frac{b-a}{2} + 1 &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; \frac{b-a}{2} -1 &amp; \frac{b-a}{2} + 1  &amp; 0 \\
0 &amp; 0 &amp; 0 &amp; \frac{b-a}{2} -1 &amp; \frac{b-a}{2} + 1 \\
\end{bmatrix}
\]</span> <span class="math display">\[
A =
\begin{bmatrix}
1.0 &amp; 0.0 &amp; 0.0 &amp; 0.0 &amp; 0.0\\
-0.8 &amp; 1.2 &amp; 0.0 &amp; 0.0 &amp; 0.0\\
0.0 &amp; -0.8 &amp; 1.2 &amp; 0.0 &amp; 0.0\\
0.0 &amp; 0.0 &amp; -0.8 &amp; 1.2 &amp; 0.0\\0.0 &amp; 0.0 &amp; 0.0 &amp; -0.8 &amp; 1.2
\end{bmatrix}
\]</span></p>
</section>
<section id="section-30" class="slide level2 smaller">
<h2></h2>
<p><span class="math display">\[
A^{-1} =
\begin{bmatrix}
1.0 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
0.6667 &amp; 0.8333 &amp; 0 &amp; 0 &amp; 0\\
0.4444 &amp; 0.5556 &amp; 0.8333 &amp; 0 &amp; 0\\
0.2963 &amp; 0.3704 &amp; 0.5556 &amp; 0.8333 &amp; 0\\
0.1975 &amp; 0.2469 &amp; 0.3704 &amp; 0.5556 &amp; 0.8333
\end{bmatrix}\\
\;\\
b =
\begin{bmatrix}1\\0\\0\\0\\0\end{bmatrix}\\
\;\\
\Phi =
\begin{bmatrix}1.0\\0.6667\\0.4444\\0.2963\\0.1975\end{bmatrix}\\
\]</span></p>
<p>o alternativamente podemos iterar progresivamente la fluencia mediante Gauss-Seidel:</p>
<p><span class="math display">\[
L =
\begin{bmatrix}
0 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
0.6667 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
0.4444 &amp; 0.5556 &amp; 0 &amp; 0 &amp; 0\\
0.2963 &amp; 0.3704 &amp; 0.5556 &amp; 0 &amp; 0\\
0.1975 &amp; 0.2469 &amp; 0.3704 &amp; 0.5556 &amp; 0
\end{bmatrix}\\
\;\\
D =
\begin{bmatrix}
1.0 &amp; 0 &amp; 0 &amp; 0 &amp; 0\\
0 &amp; 0.8333 &amp; 0 &amp; 0 &amp; 0\\
0 &amp; 0 &amp; 0.8333 &amp; 0 &amp; 0\\
0 &amp; 0 &amp; 0 &amp; 0.8333 &amp; 0\\
0 &amp; 0 &amp; 0 &amp; 0 &amp; 0.8333
\end{bmatrix}\\
\]</span></p>
<p>En este caso, la matriz <span class="math inline">\(D\)</span> es la matriz nula. Para que tenga sentido, modificamos el esquema Gauss-Seidel y lo aplicamos de este modo:</p>
<p><span class="math display">\[
A = L + D .
\]</span></p>
<p><span class="math display">\[
D\Phi = b - L\Phi,
\]</span> <span class="math display">\[
\Phi_{i+1} = D^{-1} (b - L\Phi_i),
\]</span></p>
</section>
<section id="section-31" class="slide level2 smaller">
<h2></h2>
<p><span class="math display">\[
\Phi_0 = \begin{bmatrix}1.0\\0\\0\\0\\0\end{bmatrix},\\
\;
\Phi_1 = \begin{bmatrix}1.0\\0\\0\\0\\0\end{bmatrix},\\
\;
\Phi_2 = \begin{bmatrix}1.0\\0.667\\0\\0\\0\end{bmatrix},\\
\;
\Phi_3 = \begin{bmatrix}1.0\\0.667\\0.444\\0\\0\end{bmatrix},\\
\;
\Phi_4 = \begin{bmatrix}1.0\\0.667\\0.444\\0.296\\0\end{bmatrix},\\
\;
\Phi_5 = \begin{bmatrix}1.0\\0.667\\0.444\\0.296\\0.198\end{bmatrix}\cdots\\
\]</span></p>
<ul>
<li><span class="math inline">\(\Phi_0\)</span> debería ser una estimación razonable de la fluencia, normalmente elaborada mediante trazado de rayos para calcular la fluencia primaria. Si hubiéramos supuesto que no hay atenuación <em>primaria</em>:</li>
</ul>
<p><span class="math display">\[
\Phi_0 = \begin{bmatrix}1.0\\1.0\\1.0\\1.0\\1.0\end{bmatrix},\\
\;
\Phi_1 = \begin{bmatrix}1.0\\0.667\\0.667\\0.667\\0.667\end{bmatrix},\\
\;
\Phi_2 = \begin{bmatrix}1.0\\0.667\\0.444\\0.444\\0.444\end{bmatrix},\\
\;
\Phi_3 = \begin{bmatrix}1.0\\0.667\\0.444\\0.296\\0.296\end{bmatrix},\\
\;
\Phi_4 = \begin{bmatrix}1.0\\0.667\\0.444\\0.296\\0.198\end{bmatrix},\\
\;
\Phi_5 = \begin{bmatrix}1.0\\0.667\\0.444\\0.296\\0.198\end{bmatrix}\cdots\\
\]</span></p>
<ul>
<li>Es interesante notar que la solución final no depende del valor que se elija para <span class="math inline">\(\Phi_0\)</span>. <span class="math inline">\(\Phi_5\)</span> se comporta como un punto fijo: <span class="math inline">\(\Phi_5 = \Phi_6 = \Phi_7 = \cdots\)</span></li>
<li>También se observa que, <em>probablemente</em>, tenemos que hacer <em>como mucho</em> tantas iteraciones como elementos en el espacio de fase consideremos, dependiendo de lo cerca que empecemos de la solución final.</li>
</ul>
</section>
<section id="section-32" class="slide level2 smaller">
<h2></h2>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Dificultad de implementación de un algoritmo de resolución de la ecuación de transporte de Boltzmann</strong></p>
</div>
<div class="callout-content">
<p>La implementación de un algoritmo de este tipo implica poder particularizar una matriz general <span class="math inline">\(A\)</span> reescalándola por las dimensiones del problema, introduciendo los valores concretos de las secciones eficaces de dispersión que a su vez dependen de los valores extraídos de las imágenes del paciente (modelado físico) y por el tipo y la energía del haz empleado.</p>
<p>Durante mucho tiempo se consideró mucho más realizable una implementación de algoritmo explícito mediante Montecarlo que por métodos analíticos.</p>
<p>La ventaja de los métodos analíticos es que una vez implementados son mucho más eficientes calculando.</p>
</div>
</div>
</div>
<h4 id="implementación-comercial">Implementación comercial</h4>
<ul>
<li>La casa comercial Varian implementa en su sistema de planificación Eclipse dos algoritmos:
<ul>
<li><strong>Acuros XB</strong>: basado en la resolución de la ecuación de transporte de Boltzmann.</li>
<li><strong>AAA</strong> <em>(<strong>A</strong>nalytical <strong>A</strong>nisotropic <strong>A</strong>lgorithm)</em>: de tipo superposición convolución.</li>
</ul></li>
</ul>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Desarrollo de Acuros XB</strong></p>
</div>
<div class="callout-content">
<p>Acuros XB fue desarrollado por empleados de Transpire Inc.&nbsp;en el Laboratorio de Los Álamos.</p>
</div>
</div>
</div>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Velocidad de cálculo de Acuros XB</strong></p>
</div>
<div class="callout-content">
<p>Este algoritmo, mediante el empleo de GPU, calcula distribuciones de dosis que incluyen campos de intensidad modulada en tiempos inferiores a los de AAA (incluso empleando cálculo distribuido).</p>
</div>
</div>
</div>
</section>
<section id="section-33" class="slide level2 smaller">
<h2></h2>
<h3 id="métodos-explícitos.-montecarlo">Métodos explícitos. Montecarlo</h3>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>En qué consiste el método de Montecarlo</strong></p>
</div>
<div class="callout-content">
<p><strong>Método numérico</strong>, desarrollado por S.Ulam y J.von Neumann en 1946​, que permite resolver problemas complejos mediante <strong>simulación de variables aleatorias</strong>​</p>
</div>
</div>
</div>
<ul>
<li>El método aprovecha la <em>naturaleza distribuida aleatoria</em> de muchos de los procesos que se dan en el transporte de radiación.</li>
<li>Por ejemplo: desde la fuente de radiación se emiten partículas según una <strong>distribución de energía</strong> y una <strong>distribución de direcciones.</strong> Las partículas emitidas cambian de posición según una <strong>distribución de alcances</strong>. Los diferentes tipos de interacción siguen una <strong>distribución de probabilidades relativas de interacción</strong>. Dependiendo de la interacción hay una cierta <strong>probabilidad de deposición de energía</strong> de forma local y <strong>de dispersión</strong> llevándose cierta energía y de generar partículas secundarias. <span class="alert"><strong><em>Estos procesos secundarios abren un árbol de partículas de las que también se tienen que seguir y registrar</em></strong></span>.</li>
</ul>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Implementación del método de Montecarlo</strong></p>
</div>
<div class="callout-content">
<p>Para implementar una simulación Montecarlo es necesario generar números aleatorios según cada una de las distribuciones de probabilidad que siguen las variables aleatorias que describen el problema.</p>
<p>Cada partícula genera una <strong>historia</strong> o <em>registro de todas las interacciones que ha sufrido</em>. El resultado de la <strong>simulación</strong> se obtiene por acumulo de historias y es de carácter no determinista, si bien la <span class="alert"><strong>varianza</strong></span> del resultado <span class="alert"><strong>se reduce a medida que aumenta el número de historias simuladas</strong></span>.</p>
</div>
</div>
</div>
</section>
<section id="section-34" class="slide level2 smaller">
<h2></h2>
<h4 id="estrategias-posibles-de-simulación">Estrategias posibles de simulación<sup>1</sup></h4>
<table class="caption-top">
<colgroup>
<col style="width: 23%">
<col style="width: 33%">
<col style="width: 43%">
</colgroup>
<thead>
<tr class="header">
<th>Clase</th>
<th>Ventajas</th>
<th>Desventajas</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Detallada (analógica), interacción por interacción</td>
<td>Nominalmente exacta</td>
<td>Realizable solo para energías bajas y medios sin profundidades grandes<br> Requiere bases de datos muy grandes (la interpolación no es un problema)</td>
</tr>
<tr class="even">
<td>Clase I (condensada) agrupación completa</td>
<td>Funciona para energías altas y medios extensos</td>
<td>Dificultades para describir desplazamientos espaciales<br>Los cruces de interfaces requieren acciones específicas<br>Difícil de incorporar modelos de interacción puramente numéricos<br>Usualmente aplicada solo a dispersión elástica, no es fácil para colisiones inelásticas y bremsstrahlung</td>
</tr>
<tr class="odd">
<td>Clase II (mixta)</td>
<td>Los eventos duros se describen <em>exactamente</em> a partir de sus <em>DCS</em>s<sup>2</sup><br>La dispersión elástica, inelástica y el bremsstrahlung se <em>ajustan</em> independientemente<br>Flexible (desde detallada hasta clase I)</td>
<td>Lenta cuando los umbrales son demasiado pequeños</td>
</tr>
</tbody>
</table>
<aside><ol class="aside-footnotes"><li id="fn6"><p><a href="https://indico.cern.ch/event/656336/contributions/2729565/attachments/1552750/2440304/Salvat-MCprinciples.pdf">Principles of Monte Carlo calculations</a></p></li><li id="fn7"><p>Differential Cross Sections</p></li></ol></aside></section>
<section id="section-35" class="slide level2 smaller">
<h2></h2>
<h4 id="simulaciones-montecarlo-con-aplicación-clínica-en-radioterapia">Simulaciones Montecarlo con aplicación clínica en Radioterapia</h4>
<div class="columns">
<div class="column" style="width:70%;">
<p>La aplicación a la Radioterapia implica dos etapas en la simulación, que por razones de eficiencia de cálculo se suelen hacer por separado.</p>
<ol type="1">
<li>Simular lo que ocurre en el acelerador.</li>
</ol>
<ul>
<li>Requiere un modelo geométrico y físico de los elementos del cabezal del acelerador.</li>
<li>Se obtiene un mapa de fases que es particularizable para aplicarlo en la siguiente fase.</li>
</ul>
<ol start="2" type="1">
<li>Simular lo que ocurre en cada paciente.</li>
</ol>
<ul>
<li>Requiere un modelo geométrico y físico del paciente a partir de las imágenes de CT.</li>
</ul>
</div><div class="column" style="width:30%;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="images/PrimoLinacHead.jpg" class="quarto-figure quarto-figure-center" height="400"></p>
</figure>
</div>
</div></div>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Mapa de fases</strong></p>
</div>
<div class="callout-content">
<p>Descripción de la distribución de energía y dirección de todas las partículas que salen del acelerador y son relevantes para computar el transporte de radiación en el paciente.</p>
</div>
</div>
</div>
</section>
<section id="section-36" class="slide level2 smaller">
<h2></h2>
<h4 id="simulación-del-acelerador">Simulación del acelerador</h4>
<div class="columns">
<div class="column" style="width:55%;">
<ul>
<li>El modelo geométrico del cabezal del acelerador implica introducir simplificaciones y además no es posible contar con un espacio de fases propio de cada situación particular que se presenta en la práctica clínica.</li>
<li>Mediante los datos medidos en el comisionado (PDDs, OF, OARs) se ajustan los parámetros de la simulación así como el modelo para la particularización del espacio de fases y de la intensidad de la fluencia.</li>
<li>Este proceso se realiza durante la puesta en marcha del programa de simulación para el cálculo de la dosis.</li>
<li>A partir de ahí, el acelerador es una “caja negra” de la que sale radiación con la distribución obtenida.</li>
</ul>
</div><div class="column" style="width:45%;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="images/AjusteMontecarloDD.png" class="quarto-figure quarto-figure-center"></p>
</figure>
</div>
</div></div>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Especificación del mapa de fases</strong></p>
</div>
<div class="callout-content">
<p>Existe un convenio de la IAEA para la especificación de los mapas de fases. Para más información consultar R. Capote et al., Phase-Space Database for External Beam Radiotherapy. Report INDC (NDS)-0484, International Nuclear Data Committee, International Atomic Energy Agency 2006, Vienna, Austria en <a href="https://www-nds.iaea.org/publications">IAEA Nuclear Data Services</a></p>
</div>
</div>
</div>
</section>
<section id="section-37" class="slide level2 smaller">
<h2></h2>
<h4 id="simulación-del-paciente">Simulación del paciente</h4>
<div class="columns">
<div class="column" style="width:55%;">
<ul>
<li>El paciente se simula como un conjunto de vóxeles, cada uno caracterizado por una densidad electrónica, un número atómico efectivo y un poder de frenado másico.</li>
<li>Como resultado se obtiene una dosis promediada en cada vóxel.</li>
<li>El número de historias que es necesario calcular depende de la resolución espacial y de la precisión de cálculo requerida: una precisión del 1% exige simular aproximadamente 10,000 historias por vóxel.</li>
</ul>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Modelado del paciente</strong></p>
</div>
<div class="callout-content">
<p>La caracterización de cada vóxel se realiza a partir de la información extraída de las imágenes de CT con la incertidumbre asociada. Como mejora, algunos sistemas emplean caracterizaciones simplificadas a un número reducido de materiales que después se interpolan.</p>
</div>
</div>
</div>
</div><div class="column" style="width:45%;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="images/PatientModelingRogers.png"></p>
<figcaption><a href="https://people.physics.carleton.ca/~drogers/pubs/papers/MC_inRadiotherapy_PiCanada58_2002_63_70.pdf">Rogers. Monte Carlo Techniques in Radiotherapy</a></figcaption>
</figure>
</div>
</div></div>
</section>
<section id="section-38" class="slide level2 smaller">
<h2></h2>
<h4 id="algunas-implementaciones-de-propósito-general-empleadas-en-radioterapia">Algunas implementaciones de propósito general empleadas en radioterapia</h4>
<div class="columns">
<div class="column" style="width:55%;">
<ul>
<li>ETRAN/ITS (Halbleib 1988, Seltzer 1991)</li>
<li>EGS4 (Nelson et al 1997)</li>
<li>EGSnrc (Kawrakow 2000)</li>
<li>MCNP4 (Briesmeister 2000)</li>
<li>PENELOPE (Sempau et al 1997)
<ul>
<li><a href="https://pypenelope.sourceforge.net/">pyPENELOPE</a></li>
</ul></li>
<li>GEANT3 (1995) y GEANT4 (2003)
<ul>
<li><a href="https://fismed.ciemat.es/GAMOS/gamos.php">GAMOS</a></li>
</ul></li>
</ul>
</div><div class="column" style="width:45%;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="images/ElectronShowerPyPenelope.png"></p>
<figcaption><a href="https://pypenelope.sourceforge.net/tutorials/shower.html">Cascada electrónica calculada mediante pyPenelope</a></figcaption>
</figure>
</div>
</div></div>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Limitación en la práctica clínica</strong></p>
</div>
<div class="callout-content">
<p>Estas implementaciones se pueden utilizar para realizar simulaciones detalladas de situaciones que se dan en la práctica clínica, pero son difíciles de reutilizar para pacientes diferentes.</p>
<p>Por otra parte, los tiempos de cálculo que requieren no son aptos para la práctica clínica.</p>
</div>
</div>
</div>
</section>
<section id="section-39" class="slide level2 smaller">
<h2></h2>
<h4 id="implementaciones-clínicas">Implementaciones clínicas<sup>1</sup></h4>
<table class="caption-top">
<thead>
<tr class="header">
<th><strong>Radiación</strong></th>
<th><strong>Algoritmo</strong></th>
<th><strong>Planificador</strong></th>
<th><strong>Fabricante</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Fotones</td>
<td>xvmc++</td>
<td>Monaco</td>
<td>Elekta</td>
</tr>
<tr class="even">
<td>Electrones</td>
<td>eMC</td>
<td>Eclipse</td>
<td>Varian</td>
</tr>
<tr class="odd">
<td>Protones</td>
<td>RayStation 6</td>
<td>RayStation</td>
<td>RaySearch Labs</td>
</tr>
</tbody>
</table>
<p>Para <strong>reducir los tiempos de cálculo</strong> se emplean diferentes estrategias:</p>
<ul>
<li><p>Se utilizan <strong>historias condensadas</strong> para el transporte de electrones. Estos planteamientos se utilizan en los códigos que se implementan para el cálculo de haces de <strong>fotones y electrones</strong>. Corresponden a diferentes implementaciones de algoritmos del tipo <span class="alert"><strong><em>VMC</em></strong></span> (<span class="alert"><em><strong>V</strong>oxel <strong>M</strong>onte <strong>C</strong>arlo</em></span>) o <span class="alert"><strong><em>MMC</em></strong></span> (<span class="alert"><em><strong>M</strong>acro <strong>M</strong>onte <strong>C</strong>arlo</em></span>)</p></li>
<li><p>Se <strong>desprecian algunas interacciones y partículas secundarias</strong> que no representan un porcentaje importante en el depósito de energía para la resolución de cálculo típica empleada en la planificación de tratamientos. Este planteamiento es propio de los algoritmos de <strong>protones e iones pesados</strong>.</p></li>
</ul>
<aside><ol class="aside-footnotes"><li id="fn8"><p>La lista no es exhaustiva</p></li></ol></aside></section>
<section id="section-40" class="slide level2 smaller">
<h2></h2>
<h4 id="algoritmos-para-electrones">Algoritmos para electrones</h4>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Inadecuación de los algoritmos deterministas</strong></p>
</div>
<div class="callout-content">
<p>Por la propia naturaleza de los electrones, los algoritmos para el cálculo de la dosis en campos de electrones basados en métodos analíticos de integración o interpolación no producen buenos resultados para los casos que se presentan en la práctica clínica.</p>
</div>
</div>
</div>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Cálculo de tratamientos de electrones</strong></p>
</div>
<div class="callout-content">
<p>En ocasiones los tratamientos de electrones se realizan sin determinar la distribución espacial de la dosis en el planificador. Se calcula únicamente y de forma manual las unidades monitor necesarias para dar la dosis de prescripción en el eje del campo a una profundidad dada.</p>
</div>
</div>
</div>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Factores de campo para bloques estándar</strong></p>
</div>
<div class="callout-content">
<p>Para realizar estos cálculos manuales es necesario tener tabulados para todas las energías disponibles de electrones los factores de campo correspondientes a una serie de bloques estándar, normalmente de forma circular con un rango de diámetros.</p>
</div>
</div>
</div>
<h4 id="emc">eMC</h4>
<p>Implementa Macro Monte Carlo (MMC) (tiempo de cálculo para un campo de electrones de 20x20 cm (20 MeV) con una precisión del 1% y una cuadrícula de 2 mm: aproximadamente una hora). La mayoría de las situaciones clínicas de interés son menos exigentes. Un cálculo típico puede estar en el orden de minutos.</p>
<p>Implementa también el método <strong>Local-to-Global</strong>: no es necesario manejar las interacciones básicas a escala microscópica directamente en el modelo del paciente. Las interacciones microscópicas precalculadas (escala local) se utilizan durante el cálculo de dosis macroscópico (escala global).</p>
</section>
<section id="section-41" class="slide level2 smaller">
<h2></h2>
<p><strong>Bases físicas del algoritmo eMC</strong><sup>1</sup></p>
<div class="columns">
<div class="column" style="width:65%;">
<ul>
<li><p>Los datos de CT del paciente se preprocesan: cada vóxel se clasifica en una de cinco categorías según la densidad de masa (Aire, Fantoma de Pulmón, Agua, Lucite, Fantoma de Hueso Sólido).</p></li>
<li><p>Los vóxeles se etiquetan con un <em>índice de esfera</em> que define esferas macroscópicas de diferentes tamaños. Cada esfera define un paso de transporte a lo largo de la trayectoria del electrón.</p></li>
<li><p>En regiones homogéneas, las esferas son grandes. Cuando la trayectoria de interacción se acerca a una inhomogeneidad, las esferas se hacen más pequeñas. El <em>índice de esfera</em> local describe la esfera más grande alrededor del vóxel local que no alcanza la inhomogeneidad.</p></li>
<li><p>Para los 5 materiales preestablecidos, se han realizado precálculos extensivos utilizando el código EGSnrc <em>en el laboratorio</em> para 30 energías diferentes entre 0.2 y 25 MeV y diferentes tamaños de esfera. Los resultados de estos cálculos microscópicos se almacenan en la base de datos MMC como Funciones de Densidad de Probabilidad (<span class="math inline">\(PDF\)</span>s).</p></li>
</ul>
</div><div class="column" style="width:35%;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="images/eMCScheme.png" class="quarto-figure quarto-figure-center"></p>
</figure>
</div>
</div></div>
<aside><ol class="aside-footnotes"><li id="fn9"><p><a href="https://physik.gesundheitsverbund.at/eMC/eMC.htm">Wiener Gesundheitsverbund</a></p></li></ol></aside></section>
<section id="section-42" class="slide level2 smaller">
<h2></h2>
<ul>
<li><p>Las <span class="math inline">\(PDF\)</span>s se almacenan en la configuración del TPS y se utilizan durante el cálculo de dosis eMC. En cada esfera, las <span class="math inline">\(PDF\)</span>s dan la posición de salida, dirección y energía de los electrones primarios que emergen de la esfera con los parámetros de radio, material y energía incidente del electrón.</p></li>
<li><p>Los vóxeles que no caen exactamente en una de las 5 categorías de densidad se manejan estadísticamente: si un vóxel tiene una densidad de masa justo entre agua y lucite, entonces durante 50 de cada 100 interacciones se tratará como agua, las otras 50 interacciones como lucite.</p></li>
</ul>

<img data-src="images/tilted_seedloop.gif" class="quarto-figure quarto-figure-center r-stretch"></section>
<section id="section-43" class="slide level2 smaller">
<h2></h2>
<p><strong>Modelo de Espacio de Fases Inicial <em>IPS</em></strong></p>
<p>Describe en un plano 95 cm por debajo del foco nominal (5 cm por encima del isocentro) las principales fuentes de fotones y electrones del haz clínico:</p>
<ul>
<li>El haz principal de electrones divergentes (fuente: lámina de dispersión 10 cm por debajo del foco nominal)</li>
<li>El haz principal de fotones divergentes (misma fuente)</li>
<li>El segundo haz de electrones divergentes (fuente: punto virtual 50 cm por debajo del foco nominal)</li>
<li>El segundo haz de fotones divergentes (misma fuente)</li>
<li>Electrones de borde (fuente lineal alrededor de la apertura del aplicador o inserto)</li>
<li>Fotones de transmisión, que consisten en:
<ul>
<li>Fotones de Bremsstrahlung producidos en el inserto del aplicador de cerrobend</li>
<li>Fotones principales, que pasan a través del inserto del aplicador (¡se endurecen!)</li>
<li>Fotones principales después de la dispersión Compton en el inserto del aplicador</li>
</ul></li>
</ul>
<p>El modelo IPS también contiene un modelo del cabezal de tratamiento del acelerador, los detalles del aplicador de electrones y los posibles modos de energía.</p>
</section>
<section id="section-44" class="slide level2 smaller">
<h2></h2>
<p><strong>Números Aleatorios</strong></p>
<ul>
<li><p>Los números aleatorios utilizados en eMC son <em>pseudoaleatorios</em> en el sentido de que se utiliza un <em>valor de semilla</em> para inicializar el generador de números aleatorios.</p></li>
<li><p>Usar un valor de semilla concreto implica resultados exactamente iguales. <span class="alert"><em>Un valor de semilla diferente implica un resultado ligeramente diferente pero igualmente válido</em></span>.</p></li>
<li><p>Esto solo se puede ver si el número de partículas es muy bajo. Si se aumenta el número de partículas, la diferencia entre las curvas calculadas disminuye.</p></li>
</ul>
<div class="columns">
<div class="column" style="width:50%;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="images/10000seed_anim.gif" height="300"></p>
<figcaption>Simulación de 10000 electrones iniciales</figcaption>
</figure>
</div>
</div><div class="column" style="width:50%;">
<div class="quarto-figure quarto-figure-center">
<figure>
<p><img data-src="images/1Mio_seed_anim.gif" height="300"></p>
<figcaption>Simulación de 1 millón de electrones iniciales</figcaption>
</figure>
</div>
</div></div>
</section>
<section id="section-45" class="slide level2 smaller">
<h2></h2>
<h4 id="algoritmos-para-protones">Algoritmos para protones</h4>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Limitaciones de los algoritmos para protones</strong></p>
</div>
<div class="callout-content">
<p>Por la naturaleza de los protones, los algoritmos de tipo <em>pencil beam</em> producen resultados suficientemente buenos para la mayoría de los casos que se presentan en la práctica clínica. Sus principales limitaciones están en el cálculo del <em>halo</em> (región externa al haz primario en la que debido a radiación dispersada aparece dosis con relevancia clínica) y las correcciones por inhomogeneidad que contribuyen a aumentar la incertidumbre de rango.</p>
</div>
</div>
</div>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Algoritmos tipo <em>pencil beam</em></strong></p>
</div>
<div class="callout-content">
<p>Algoritmos que son una variante de los de convolución/superposición y en los que la integración en profundidad del kernel se ha condensado mediante un cálculo previo. En situaciones sin inhomogeneidades reducen mucho el tiempo de cálculo sin comprometer apreciablemente la exactitud.</p>
</div>
</div>
</div>
<p><strong>Bases físicas del algoritmo Montecarlo implementado en el planificador RayStation</strong><sup>1</sup></p>
<ul>
<li>El código Monte Carlo transporta protones primarios e iones secundarios (protones, deuterones y alfas).</li>
<li>Se aplica un método de transporte de Clase II para los protones primarios y secundarios. Las partículas secundarias más pesadas (deuterones y alfas secundarios) se transportan solo teniendo en cuenta la pérdida de energía en aproximación de frenado continuo (CSDA).</li>
<li>Los productos de reacción neutros (neutrones y gammas) no se transportan, pero sus fracciones dadas de la energía absorbida se incluyen en el balance energético y se consideran como fuga.</li>
</ul>
<aside><ol class="aside-footnotes"><li id="fn10"><p><a href="https://www.raysearchlabs.com/siteassets/about-overview/media-center/wp-re-ev-n-pdfs/white-papers/proton-monte-carlo-dose-calculation-in-raystation2.pdf">Proton Monte Carlo Dose Calculation RayStation</a></p></li></ol></aside></section>
<section id="section-46" class="slide level2 smaller">
<h2></h2>
<ul>
<li><p>No se considera la producción de electrones delta (los electrones liberados tienen en promedio un rango muy corto y no son relevantes para el cálculo de la dosis física en vóxeles de tamaño 1 mm o más grandes).</p></li>
<li><p>El motor de dosis MC informa la dosis física como dosis a una pequeña cavidad de agua incrustada en el medio local, es decir, como dosis en agua en concordancia con el motor de dosis con algoritmo <em>pencil beam</em>.</p></li>
<li><p>La simulación de transporte se realiza en geometrías representadas por rejillas de vóxeles rectilíneos donde un vóxel se caracteriza por su densidad de masa, composición elemental y energía de ionización media.</p>
<p><em>Modificadores de haz (range shifters y bloques de colimación)</em></p></li>
<li><p>La simulación en los modificadores de haz se lleva a cabo utilizando la misma mecánica de transporte y modelos físicos que para los pacientes, con la diferencia de que las deposiciones de energía solo se registran mientras están en la rejilla de transporte del paciente.</p></li>
<li><p>La simulación Montecarlo comienza generando protones primarios en un plano sobre el paciente, o sobre el modificador del haz más alejado si está presente.</p></li>
<li><p>Los protones se propagan a través de la malla de cálculo hasta que se detienen o escapan de la geometría.</p></li>
</ul>
</section>
<section id="section-47" class="slide level2 smaller">
<h2></h2>
<h4 id="cálculo-final-de-dosis">Cálculo final de dosis</h4>
<ul>
<li>El error estadístico por vóxel se estima como la varianza de la dosis por vóxel considerando 12 lotes.</li>
<li>Se calcula una única estimación de error estadístico por haz como el error medio de una desviación estándar en todos los vóxeles con una dosis superior al 50% de la dosis máxima por haz.</li>
<li>La dosis final calculada por MC se marcará como clínica si el error estadístico por haz es menor que un umbral definido por el usuario. De lo contrario, la dosis se considerará aproximada.</li>
<li>El error estadístico no se calcula cuando el motor de dosis MC se utiliza para dirigir la optimización. Por lo tanto, la dosis después de la optimización siempre se considerará aproximada cuando se seleccione el motor de dosis MC para la optimización.</li>
<li>El cálculo es determinista, es decir, cálculos repetidos producen el mismo resultado numérico.</li>
</ul>



<img data-src="images/MonteCarloProtonDoseDistribution.png" class="quarto-figure quarto-figure-center r-stretch"></section>

    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<p><img src="images/LogoUCM.jpg" class="slide-logo"></p>
<div class="footer footer-default">
<p>Algoritmos cálculo dosis. Física de la radioterapia</p>
</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="../site_libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="../site_libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="../site_libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="../site_libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="../site_libs/revealjs/plugin/reveal-chalkboard/plugin.js"></script>
  <script src="../site_libs/revealjs/plugin/multiplex/socket.io.js"></script>
  <script src="../site_libs/revealjs/plugin/multiplex/multiplex.js"></script>
  <script src="../site_libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="../site_libs/revealjs/plugin/notes/notes.js"></script>
  <script src="../site_libs/revealjs/plugin/search/search.js"></script>
  <script src="../site_libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="../site_libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleChalkboard(event)\"><kbd>b</kbd> Toggle Chalkboard</a></li>\n<li class=\"slide-tool-item\" data-item=\"6\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleNotesCanvas(event)\"><kbd>c</kbd> Toggle Notes Canvas</a></li>\n<li class=\"slide-tool-item\" data-item=\"7\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.downloadDrawings(event)\"><kbd>d</kbd> Download Drawings</a></li>\n<li class=\"slide-tool-item\" data-item=\"8\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'chalkboard': {"buttons":true},
'multiplex': {"secret":null,"id":"348d2a8845da3e75","url":"https://reveal-multiplex.glitch.me/"},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, RevealChalkboard, QuartoSupport,

          RevealMath,
          
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    <script id="quarto-html-after-body" type="application/javascript">
    window.document.addEventListener("DOMContentLoaded", function (event) {
      const toggleBodyColorMode = (bsSheetEl) => {
        const mode = bsSheetEl.getAttribute("data-mode");
        const bodyEl = window.document.querySelector("body");
        if (mode === "dark") {
          bodyEl.classList.add("quarto-dark");
          bodyEl.classList.remove("quarto-light");
        } else {
          bodyEl.classList.add("quarto-light");
          bodyEl.classList.remove("quarto-dark");
        }
      }
      const toggleBodyColorPrimary = () => {
        const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
        if (bsSheetEl) {
          toggleBodyColorMode(bsSheetEl);
        }
      }
      toggleBodyColorPrimary();  
      const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
      tabsets.forEach(function(tabset) {
        const tabby = new Tabby('#' + tabset.id);
      });
      const isCodeAnnotation = (el) => {
        for (const clz of el.classList) {
          if (clz.startsWith('code-annotation-')) {                     
            return true;
          }
        }
        return false;
      }
      const onCopySuccess = function(e) {
        // button target
        const button = e.trigger;
        // don't keep focus
        button.blur();
        // flash "checked"
        button.classList.add('code-copy-button-checked');
        var currentTitle = button.getAttribute("title");
        button.setAttribute("title", "Copied!");
        let tooltip;
        if (window.bootstrap) {
          button.setAttribute("data-bs-toggle", "tooltip");
          button.setAttribute("data-bs-placement", "left");
          button.setAttribute("data-bs-title", "Copied!");
          tooltip = new bootstrap.Tooltip(button, 
            { trigger: "manual", 
              customClass: "code-copy-button-tooltip",
              offset: [0, -8]});
          tooltip.show();    
        }
        setTimeout(function() {
          if (tooltip) {
            tooltip.hide();
            button.removeAttribute("data-bs-title");
            button.removeAttribute("data-bs-toggle");
            button.removeAttribute("data-bs-placement");
          }
          button.setAttribute("title", currentTitle);
          button.classList.remove('code-copy-button-checked');
        }, 1000);
        // clear code selection
        e.clearSelection();
      }
      const getTextToCopy = function(trigger) {
          const codeEl = trigger.previousElementSibling.cloneNode(true);
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
      }
      const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
        text: getTextToCopy
      });
      clipboard.on('success', onCopySuccess);
      if (window.document.getElementById('quarto-embedded-source-code-modal')) {
        const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
          text: getTextToCopy,
          container: window.document.getElementById('quarto-embedded-source-code-modal')
        });
        clipboardModal.on('success', onCopySuccess);
      }
        var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
        var mailtoRegex = new RegExp(/^mailto:/);
          var filterRegex = new RegExp("https:\/\/csarux\.github\.io\/ClasesFisicaRT\/");
        var isInternal = (href) => {
            return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
        }
        // Inspect non-navigation links and adorn them if external
     	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
        for (var i=0; i<links.length; i++) {
          const link = links[i];
          if (!isInternal(link.href)) {
            // undo the damage that might have been done by quarto-nav.js in the case of
            // links that we want to consider external
            if (link.dataset.originalHref !== undefined) {
              link.href = link.dataset.originalHref;
            }
          }
        }
      function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
        const config = {
          allowHTML: true,
          maxWidth: 500,
          delay: 100,
          arrow: false,
          appendTo: function(el) {
              return el.closest('section.slide') || el.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start',
        };
        if (contentFn) {
          config.content = contentFn;
        }
        if (onTriggerFn) {
          config.onTrigger = onTriggerFn;
        }
        if (onUntriggerFn) {
          config.onUntrigger = onUntriggerFn;
        }
          config['offset'] = [0,0];
          config['maxWidth'] = 700;
        window.tippy(el, config); 
      }
      const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
      for (var i=0; i<noterefs.length; i++) {
        const ref = noterefs[i];
        tippyHover(ref, function() {
          // use id or data attribute instead here
          let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
          try { href = new URL(href).hash; } catch {}
          const id = href.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note) {
            return note.innerHTML;
          } else {
            return "";
          }
        });
      }
      const findCites = (el) => {
        const parentEl = el.parentElement;
        if (parentEl) {
          const cites = parentEl.dataset.cites;
          if (cites) {
            return {
              el,
              cites: cites.split(' ')
            };
          } else {
            return findCites(el.parentElement)
          }
        } else {
          return undefined;
        }
      };
      var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
      for (var i=0; i<bibliorefs.length; i++) {
        const ref = bibliorefs[i];
        const citeInfo = findCites(ref);
        if (citeInfo) {
          tippyHover(citeInfo.el, function() {
            var popup = window.document.createElement('div');
            citeInfo.cites.forEach(function(cite) {
              var citeDiv = window.document.createElement('div');
              citeDiv.classList.add('hanging-indent');
              citeDiv.classList.add('csl-entry');
              var biblioDiv = window.document.getElementById('ref-' + cite);
              if (biblioDiv) {
                citeDiv.innerHTML = biblioDiv.innerHTML;
              }
              popup.appendChild(citeDiv);
            });
            return popup.innerHTML;
          });
        }
      }
    });
    </script>
    

</body></html>